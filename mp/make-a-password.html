<!DOCTYPE html>
<html manifest="make-a-password.manifest">
  <head>

    <title>Create a Password</title>
    <meta name="viewport" content="initial-scale=1.0, width=device-width" />    
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <link rel="apple-touch-startup-image" href="startup-splash-screen.png" />  
    <link rel="stylesheet" type="text/css" href="iphone.css" media="only screen and (max-width: 1080px)" />
    <link rel="stylesheet" type="text/css" href="desktop.css" media="screen and (min-width: 481px)" />

    <style>
      body {
      margin: 0px ;
      padding: 0px ;
      color: #212121 ;
      font-family: Helvetica ;
      font-size: 14px ;
      }
      th, td {
      padding: 0px;
      text-align: left;
      background-color: lightblue;
      }
      .bitcount { 
      font-weight: bold; 
      color: crimson;  
      }
      .w-s-button {
      font-family: Helvetica ;
      font-size: 14px;
      }
      div.header {
      color: navy;
      background-color: lightblue;
      clear: left;
      text-align: center;
      }
      div.outer {
      margin: auto;
      max-width: 95vw;
      border-radius: 15px;
      background-color: lightblue;      
      }
      div.inner {
      margin-left: 10px;
      margin-top: 10px;
      margin-bottom: 10px;
      max-width: 900px;
      }
      textarea, select {
      margin-top: 5px;
      }
      textarea, select.option {
      font-size: 14px;
      }
      .helpButton {
      font-weight: bold;
      color: navy;
      background-color: yellow;
      }
      .helpBox {
      margin: 20px;
      border-radius: 15px;
      color: navy;
      border: 2px solid yellow ;
      }
      summary { display:block; }  
      summary::-webkit-details-marker { display:none; }
    </style>

    <script type="text/javascript" src="dicewareWordlist.js"></script>

    <script type="text/javascript">

///////////////////////////////////////////////////////////////////////////////    

var DBG = 0;
console.log( "js start" );  
if (DBG) { alert( "js start" ); }

window.onerror = function(error) {
    alert(error);
};

///////////////////////////////////////////////////////////////////////////////
// Use the random number generator that is (hopefully) of crypographic
// quality.

function randByteInRange( min, max ) {
    // pick a smallish number between min and max, inclusive.
    // PRE: 0 <= min <= max < 255.
    var randValArray = new Uint8Array(1);
    var result = max+1;
    // to not bias the uniformity of the distribution, keep sampling
    // till we get one that's in range:
    while (result < min || result > max) {
	window.crypto.getRandomValues( randValArray );
	result = randValArray[0];
    }
    // console.log( result );
    return result;
}

function chooseElt( ary ) {
    // randomly choose one element from ary (an array or string)
    var i = randByteInRange( 0, ary.length-1 );
    return ary[i];
}

///////////////////////////////////////////////////////////////////////////////

var Nrows = 7;
var Ncols = 4;

var Nchars = 4;

function genBase32() {
    // generate a string of length Nchars composed of randomly
    // chosen characters from among 32 options.
    // base32 strings -- rfc4648 base32 is [A..Z2..7].  With 32 options, each 
    // pair of characters is 10 bits.
    var Charset = "abcdefghijklmnopqrstuvwxyz234567";    // lower case for typing!
    var chars = "";
    for (var i = 0; i < Nchars; ++i) {
	chars += chooseElt( Charset );
    }
    return chars;
}

function genBase32strings( nstrings ) {
    // Returns Nstrings of them
    var strings = [ ];
    for (var i = 0; i < nstrings; ++i) {
	strings.push( [ genBase32(), 20 ] );    // [string,bitcount]
    }
    return strings;
}

function genPrefixedBase32strings( nstrings ) {
    var UppercaseLetters = "ABCDEFGHJKLMNPQRSTUVWXY";
    var strings = [ ];
    for (var i = 0; i < nstrings; ++i) {
	var string = chooseElt(UppercaseLetters) + genBase32();
	strings.push( [ string, 24 ] );    // [string,bitcount].  actually 24.52
    }
    return strings;
}

function randomSep() {		      
    return chooseElt( "-.,:" );
}		      

///////////////////////////////////////////////////////////////////////////////


function getRoll() {
    var digits = '';
    for (var i = 0; i < 5; ++i) {    // 5 dice
	digits += randByteInRange(1,6).toString();
    }
    return digits;
}
function genDiceware( nwords ) {
    words = [];
    for (var roll = 0; roll < nwords; ++roll) {
	words.push( [ DicewareWordlist[ getRoll() ], 13 ] );    // [word,bitcount]. actually 12.92
    }
    return words;
}

///////////////////////////////////////////////////////////////////////////////

var itemsChosen = [ ];
var bitcountRollup = 0;
var randomlyChosenSep = randomSep();

function populateButtons() {
    var Nitems = Nrows * Ncols;    // note that this needs to be even
    var strings = genPrefixedBase32strings( Nitems / 2 );
    var words = genDiceware( Nitems / 2 );
    var items = strings.concat(words);
    for (var r = 0 ; r < Nrows; ++r) {
	for (var c = 0 ; c < Ncols; ++c) {
	    var buttonID = 'b' + r.toString() + c.toString();
	    var itemAndBitcount = items.pop();
	    document.getElementById( buttonID ).innerHTML = itemAndBitcount[0];
	    document.getElementById( buttonID ).bitcount = itemAndBitcount[1];
	} 
    }  
}

function indicatorForNumbits( nbits ) {
    var RedMark = ' <span style="color:red;font-size:larger;">&#10060;</span> ';    //cross mark
    var GreenMark = ' <span style="background-color:green;color:white;font-size:larger;">&#10004;</span> ';    //heavy check mark
    if (nbits >= 90) {
	return GreenMark + GreenMark + GreenMark;
    } else if (nbits >= 80) {
	return GreenMark + GreenMark + RedMark;
    } else if (nbits >= 65) {
	return GreenMark + RedMark + RedMark;
    } else {
	return RedMark + RedMark + RedMark;
    }
}			    

function clearPasswordAndNumbits() {
    itemsChosen = [];
    bitcountRollup = 0;
    randomlyChosenSep = randomSep();			 
    document.getElementById('outputText').value = "(3) When you like it, cut it from here, and  paste it to the destination";
    document.getElementById( "numBits" ).value = "0";
    document.getElementById( "indicators" ).innerHTML = indicatorForNumbits(0);
}

function getSep() {
    var seps = document.getElementById('sep');
    var chosenSep = seps.options[seps.selectedIndex].value;
    return ( (chosenSep != '*') ? chosenSep : randomlyChosenSep );    // '*' means no choice made
}

String.prototype.upcaseFirstLetter = function() {
    for (var i = 0; i <= this.length; ++i) {
	if ( this.charAt(i).match(/[a-z]/i) ) {
	    return this.slice(0,i) + this.charAt(i).toUpperCase() + this.slice(i+1);
	}
    }
    return this;  //if no letters at all		       
}

function bsel( buttonID ) {
    var newItem = document.getElementById(buttonID).innerHTML;
    if ( !itemsChosen.includes(newItem) ) {
	itemsChosen.push( newItem );
    }
    bitcountRollup += document.getElementById(buttonID).bitcount;
    //document.getElementById('outputText').value = itemsChosen.join( getSep() ).upcaseFirstLetter();
    document.getElementById('outputText').value = itemsChosen.join( getSep() );
    document.getElementById( "numBits" ).value = bitcountRollup.toString();
    document.getElementById( "indicators" ).innerHTML = indicatorForNumbits(bitcountRollup);
}

function enableCopyToClipboard() {
    document.querySelector("#copyTo").onclick = function() {
	document.querySelector("#outputText").select();
	document.execCommand('copy');
    };
}

function precheck() {
    console.log( "begin precheck" );
    var randValArray = new Uint8Array(1);
    try {
	window.crypto.getRandomValues( randValArray );
    } catch(err) {
	alert( "no window.crypto.getRandomValues(): " + err.message );
    }
    if (!randValArray[0]) {
      window.crypto.getRandomValues( randValArray );  // is it consistent?
      if (!randValArray[0]) {			 
        alert( "window.crypto.getRandomValues() returned unexpected value: " + randValArray[0] );
      }
    }
    if (DBG) { alert( "precheck passed " + randValArray[0] ); }
    console.log( "precheck passed " + randValArray[0] );
}

function bodyLoaded() {
    //generateInTextBox();
    precheck();
    populateButtons();
    document.getElementById('outputText').value = "(3) When you like it, cut it from here, and  paste it to the destination";		       
    document.getElementById( "indicators" ).innerHTML = indicatorForNumbits(0);
    document.getElementById( "re90" ).innerHTML = indicatorForNumbits(90);
    document.getElementById( "re80" ).innerHTML = indicatorForNumbits(80);
    document.getElementById( "re65" ).innerHTML = indicatorForNumbits(65);
    //enableCopyToClipboard();
    console.log( "bodyLoaded() DONE" );
}

function dbg() {
}


console.log( "js end" );
if (DBG) { alert( "js end" ); }

///////////////////////////////////////////////////////////////////////////////
    </script>   
    
  </head>
  
  <body onload="bodyLoaded();">
    
    <div class="header">
      <h1> Make a Password </h1>
    </div>
    
    <div class="outer">
    <div class="inner">
      <details>
	<summary>
	  <select id="sep">
	    <option value="*" selected>(1) Select your password's separator</option>
	    <option value="-">hyphen "-"</option>
	    <option value="">none ""</option>
	    <option value=".">period "."</option>
	    <option value=",">comma ","</option>
	    <option value=" ">space " "</option>
	    <option value=":">colon ":"</option>
	  </select>
	  &nbsp;&nbsp;&nbsp;&nbsp;<span class="helpButton">[ ? ]</span>
	</summary>
	<div class="helpBox">
	  <p>We're going to create a password that looks something
	    like &nbsp;<b><tt>if-fad-pie-crete-wheel</tt></b>&nbsp; or
	    &nbsp;<b><tt>Gkfan,Wu6ko,Jddfe</tt></b>&nbsp; or
	    &nbsp;<b><tt>G55v3:irony:fiat:Mzexu</tt></b>.
	  </p>
	  <p>
	    The goal here is passwords that are: (a) Secure for the
	    particular use. (b) Not super long -- some sites/apps limit
	    the length significantly And (c) easy to read off of one
	    place and type into another, which is sometimes needed.
	  </p>
	  <p>
	    We build the password in three steps:
	  </p>
	  <ol>
	    <li> Select the separator
	      (punctuation) that comes between the words and/or strings. You
	      can pick "None" for no punctuation; that works nice with
	      the strings that start with a capital letter. (If
	      you don't pick a separator, a random one is chosen.)</li>
	    <li> Select words
	    and/or strings from a table of randomly-selected ones, until
	      the password is long enough for the particular use.</li>
	      <li>Cut
	    the password from its box and paste it where it's needed.</li>
	  </ol>
	  <p>
	    The password box's help button has more info about when a
	    password has enough bits of entropy to be "long enough for
	    the particuar use".
	  </p>
	</div>
      </details>
    </div>
    </div>
    
    <div class="outer">
    <div class="inner">
      <table>
        <tr> <td colspan="4"> (2) Select words and strings to add</th> </tr>
<tr>  <td><button class="w-s-button" id="b00" onclick="bsel('b00')"></button></td> <td><button class="w-s-button" id="b01" onclick="bsel('b01')"></button></td> <td><button class="w-s-button" id="b02" onclick="bsel('b02')"></button></td> <td><button class="w-s-button" id="b03" onclick="bsel('b03')"></button></td>  </tr>
<tr>  <td><button class="w-s-button" id="b10" onclick="bsel('b10')"></button></td> <td><button class="w-s-button" id="b11" onclick="bsel('b11')"></button></td> <td><button class="w-s-button" id="b12" onclick="bsel('b12')"></button></td> <td><button class="w-s-button" id="b13" onclick="bsel('b13')"></button></td>  </tr>
</td> <td><button class="w-s-button" id="b20" onclick="bsel('b20')"></button></td> <td><button class="w-s-button" id="b21" onclick="bsel('b21')"></button></td> <td><button class="w-s-button" id="b22" onclick="bsel('b22')"></button></td> <td><button class="w-s-button" id="b23" onclick="bsel('b23')"></button></td>  </tr>
</td> <td><button class="w-s-button" id="b30" onclick="bsel('b30')"></button></td> <td><button class="w-s-button" id="b31" onclick="bsel('b31')"></button></td> <td><button class="w-s-button" id="b32" onclick="bsel('b32')"></button></td> <td><button class="w-s-button" id="b33" onclick="bsel('b33')"></button></td>  </tr>
</td> <td><button class="w-s-button" id="b40" onclick="bsel('b40')"></button></td> <td><button class="w-s-button" id="b41" onclick="bsel('b41')"></button></td> <td><button class="w-s-button" id="b42" onclick="bsel('b42')"></button></td> <td><button class="w-s-button" id="b43" onclick="bsel('b43')"></button></td>  </tr>
</td> <td><button class="w-s-button" id="b50" onclick="bsel('b50')"></button></td> <td><button class="w-s-button" id="b51" onclick="bsel('b51')"></button></td> <td><button class="w-s-button" id="b52" onclick="bsel('b52')"></button></td> <td><button class="w-s-button" id="b53" onclick="bsel('b53')"></button></td>  </tr>
<tr>  <td><button class="w-s-button" id="b60" onclick="bsel('b60')"></button></td> <td><button class="w-s-button" id="b61" onclick="bsel('b61')"></button></td> <td><button class="w-s-button" id="b62" onclick="bsel('b62')"></button></td> <td><button class="w-s-button" id="b63" onclick="bsel('b63')"></button></td>  </tr>  
</table>

  <button class="clear-button" id="clear" onclick="populateButtons(); clearPasswordAndNumbits();">Clear choices, start over</button>
</div>
</div>

<div class="outer">
<div class="inner">
  <textarea id="outputText" rows="3" cols="35" readonly="true">
  </textarea>
    <details>
      <summary>
	<b>Bits:</b> <input type="text" class="bitcount" id="numBits" size="3" value="0" readonly="true"/>
	<span id="indicators">&nbsp;</span>
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="helpButton">[ ? ]</span>
      </summary>
      <div class="helpBox">
	<ul>
	  <li> <span id="re65">&nbsp;</span> &nbsp;&gt;= <span class="bitcount">65 bits</span>:
	    Could be cracked in less than a year
	    by a government, but it's plenty adequate for a website where you have
	    no money or consequential personal information at risk. </li>
	  <li> <span id="re80">&nbsp;</span> &nbsp;&gt;= <span class="bitcount">80 bits</span>:
	    Secure for most things.  </li>
	  <li><span id="re90">&nbsp;</span> &nbsp;&gt;= <span class="bitcount">90 bits</span>:
	    Very secure: adequate for things
	    that would be costly if hacked, like bank accounts or credit cards or
	    important email accounts. </li>
	</ul>
    </details>
  </div>
</div>
</div>
  


<div class="outer">
<div class="inner">  
  <details>
    <summary>
      <b><i>Caveats and Notes</i></b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="helpButton">[ &gt; ]</span>
    </summary>
    <div class="helpBox">
      <p>
	<b><i>Caveats:</i></b>
      </p>
      <ol>
	<li> We assume that the <tt>window.crypto.getRandomValues()</tt>
	  function in your browser actually returns cryptographically-strong
	  random numbers, like it's supposed to.</li>
	<li> We assume this computer/phone/device has not been subverted by
	  malware which would control it or eavesdrop on its actions.</li>
      </ol>
      <p>
	<b>Notes:</b>
      </p>
      <ul>
	<li> The words are chosen from the Diceware wordlist.  The characters
	  in the strings are chosen from 'a' through 'z' and '2' through '7',
	  and the string always starts with a capital letter.</li>
      </ul>
    </div>
  </details>
</div>
</div>
</body>
</html>
